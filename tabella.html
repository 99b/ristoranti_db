<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Tabella Ristoranti</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
body {
    font-family: Arial,sans-serif;
    max-width: 95%;
    margin:30px auto;
    background:#f9f9f9;
    padding:20px; }
h2 {
    text-align:center;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin-top:20px;
    background:white;
    border-radius:10px;
    overflow:hidden;
}
th, td {
    border:1px solid #ddd;
    padding:8px 10px;
    text-align:center;
    vertical-align:top;
}
th {
    background-color:#95ada2;
    color:black;
}
tr:nth-child(even){
    background-color:#f2f2f2;
}
input {
    width:50%;
    display:block;
    margin:0 auto 15px auto;
    padding:10px;
    font-size:14px;
    border-radius:6px;
    border:1px solid #ccc;
}
button {
    border:none;
    background:none;
    cursor:pointer;
    font-size:16px;
}
button.btnDettagli:hover {
  color: #677b94;
}
button.btnElimina:hover {
  color: #946767;
}
a {
    display:block;
    text-align:center;
    margin-top:15px;
    color:#3e4f47;
    text-decoration:none;
    font-weight:bold;
}

.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.6); align-items:center; justify-content:center; }
.modal-content { background-color:#fff; padding:20px; border-radius:12px; width:90%; max-width:800px; max-height:85vh; overflow-y:auto; box-shadow:0 0 15px rgba(0,0,0,0.3); }
.modal h3 {
    margin-top:0;
    border-bottom:2px solid #95ada2;
    padding-bottom:6px;
}
.modal-close {
    float:right;
    cursor:pointer;
    font-size:20px;
    color:#666;
}
.modal-close:hover {
    color:#000;
}

.popup-flex { display:flex; flex-wrap:wrap; gap:20px; }
.popup-left { flex:1 1 50%; min-width:280px; }
.popup-right { flex:1 1 45%; min-width:250px; }
.info-row { margin-bottom:8px; }
.info-row strong { display:inline-block; width:120px; color:#555; }

.map-container { position:relative; width:100%; padding-top:100%; }
.map-container iframe { position:absolute; top:0; left:0; width:100%; height:100%; border:none; border-radius:10px; }
.map-link { display:block; margin-top:6px; text-align:center; color:#0066cc; text-decoration:none; font-weight:bold; }
.map-link:hover { text-decoration:underline; }

@media (max-width:600px){ .popup-flex { flex-direction:column; } }
</style>
</head>
<body>

<h2>
    <i class="fa-solid fa-utensils"></i> Elenco Ristoranti
</h2>
<input type="text" id="filtro" placeholder="Filtra per nome, zona o cucina...">

<table id="tabellaRistoranti">
  <thead>
    <tr>
      <th>Nome</th><th>Zona</th><th>Cucina</th><th>Prezzo</th><th>Tripadvisor</th>
      <th>Alessandro</th><th>Francesca</th><th>Giacomo</th><th>Lucia</th><th>Media</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<a href="index.html"><i class="fa-solid fa-arrow-left"></i> Torna allâ€™inserimento / modifica</a>

<div class="modal" id="popupDettagli">
  <div class="modal-content">
    <span class="modal-close" id="chiudiPopup">&times;</span>
    <h3 id="titoloPopup"></h3>
    <div class="popup-flex">
      <div class="popup-left" id="contenutoPopup"></div>
      <div class="popup-right" id="mappaPopup"></div>
    </div>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzuyvSKQkkOdyIXdxKIGxtCC7PEnOT9qwbi1CxCJYquPnQfwX-9Brs7tHzH2ccgnSh_gw/exec";

async function caricaTabella(){
  const res = await fetch(scriptURL);
  const data = await res.json();

  const arr = data.map(r=>{
    const voti = [r["Alessandro"],r["Francesca"],r["Giacomo"],r["Lucia"]].map(v=>parseFloat(v)||0).filter(v=>v>0);
    const media = voti.length ? voti.reduce((s,v)=>s+v,0)/voti.length : 0;
    return {...r, media};
  }).sort((a,b)=>{
    const aVuoto = a.media===0, bVuoto = b.media===0;
    if(aVuoto&&!bVuoto) return -1;
    if(!aVuoto&&bVuoto) return 1;
    return b.media - a.media;
  });

  const tbody = document.querySelector("#tabellaRistoranti tbody");
  tbody.innerHTML = "";

  arr.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r["Nome"]||""}</td><td>${r["Zona"]||""}</td><td>${r["Cucina"]||""}</td>
      <td>${r["Prezzo"]||""}</td><td>${r["Tripadvisor"]||""}</td>
      <td>${r["Alessandro"]||""}</td><td>${r["Francesca"]||""}</td>
      <td>${r["Giacomo"]||""}</td><td>${r["Lucia"]||""}</td>
      <td><b>${r.media? r.media.toFixed(1):""}</b></td>
      <td>
        <button class="btnDettagli" title="Dettagli" data-info='${JSON.stringify(r).replace(/'/g,"&apos;")}'>
          <i class="fa-solid fa-eye"></i>
        </button>
        <button class="btnElimina" title="Elimina" data-nome="${r["Nome"]}">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Dettagli popup
  document.querySelectorAll(".btnDettagli").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const r = JSON.parse(e.currentTarget.dataset.info.replace(/&apos;/g,"'"));
      document.getElementById("titoloPopup").textContent = r["Nome"];
      document.getElementById("contenutoPopup").innerHTML = `
        <div class="info-row"><strong>Zona:</strong>${r["Zona"]||"-"}</div>
        <div class="info-row"><strong>Indirizzo:</strong>${r["Indirizzo"]||"-"}</div>
        <div class="info-row"><strong>Cucina:</strong>${r["Cucina"]||"-"}</div>
        <div class="info-row"><strong>Prezzo:</strong>${r["Prezzo"]||"-"}</div>
        <div class="info-row"><strong>Tripadvisor:</strong>${r["Tripadvisor"]||"-"}</div>
        <div class="info-row"><strong>Alessandro:</strong>${r["Alessandro"]||"-"}</div>
        <div class="info-row"><strong>Francesca:</strong>${r["Francesca"]||"-"}</div>
        <div class="info-row"><strong>Giacomo:</strong>${r["Giacomo"]||"-"}</div>
        <div class="info-row"><strong>Lucia:</strong>${r["Lucia"]||"-"}</div>
        <div class="info-row"><strong>Media:</strong>${r.media? r.media.toFixed(1):"-"}</div>
        <hr>
        <div class="info-row"><strong>Note:</strong><br>${(r["Note"]||"<em>Nessuna nota</em>").replace(/\n/g,"<br>")}</div>
      `;
      if(r["Indirizzo"]){
        const query = encodeURIComponent("Milano, "+r["Indirizzo"]);
        document.getElementById("mappaPopup").innerHTML = `
          <div class="map-container">
            <iframe src="https://www.google.com/maps?q=${query}&output=embed" loading="lazy"></iframe>
          </div>
          <a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank" class="map-link">
            <i class="fa-solid fa-location-dot"></i> Apri su Google Maps
          </a>
        `;
      } else document.getElementById("mappaPopup").innerHTML="<em>Indirizzo non disponibile</em>";
      document.getElementById("popupDettagli").style.display="flex";
    });
  });

  // Elimina ristorante
  document.querySelectorAll(".btnElimina").forEach(btn=>{
    btn.addEventListener("click", async e=>{
      const nome = e.currentTarget.dataset.nome;
      if(!confirm(`Vuoi davvero eliminare "${nome}"?`)) return;
      await fetch(scriptURL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({elimina:true,nome})
      });
      caricaTabella();
    });
  });
}

// Popup close
document.getElementById("chiudiPopup").addEventListener("click",()=>{document.getElementById("popupDettagli").style.display="none";});
window.addEventListener("click",e=>{if(e.target.id==="popupDettagli") document.getElementById("popupDettagli").style.display="none";});

// Filtro
document.getElementById("filtro").addEventListener("input", e=>{
  const filtro = e.target.value.toLowerCase();
  document.querySelectorAll("#tabellaRistoranti tbody tr").forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(filtro)?"":"none";
  });
});

caricaTabella();
</script>
</body>
</html>
