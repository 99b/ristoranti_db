<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Tabella Ristoranti</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/99b/ristoranti_db/main/images/7845744.png" sizes="96x96">
    <link rel="stylesheet" type="text/css" href="stile_tabella.css" />
</head>
<body>

<h2><i class="fa-solid fa-utensils"></i> Elenco Ristoranti</h2>

<!-- 🔍 Barra Filtri -->
<div class="filter-bar">
    <div style="position: relative;">
        <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888;"></i>
        <input type="text" id="filtro" placeholder="Filtra per nome, zona o cucina..." style="padding-left: 30px;">
    </div>

    <div class="custom-select" id="selectCittaWrapper">
        <div class="select-display">
            <i class="fa-solid fa-earth-europe"></i>
            <span id="selectedCity">Tutte le città</span>
            <i class="fa-solid fa-angle-down freccia"></i>
        </div>
        <ul class="select-options" id="cityOptions"></ul>
    </div>
    
    <div class="custom-select" id="selectOrdinaWrapper">
        <div class="select-display">
        <i class="fa-solid fa-arrow-down-wide-short"></i>
        <span id="selectedSort">Ordina per...</span>
        <i class="fa-solid fa-angle-down freccia"></i>
        </div>
        <ul class="select-options" id="sortOptions">
        <li data-value="nome">Nome (A–Z)</li>
        <li data-value="media">Voto medio (↓)</li>
        <li data-value="tripadvisor">Tripadvisor (↓)</li>
        </ul>
    </div>

    <button class="filter-reset" id="resetFiltri">
        <i class="fa-solid fa-rotate-left"></i> Reset
    </button>
</div>

<table id="tabellaRistoranti">
  <thead>
    <tr>
      <th style="width: 100px;">Nome</th>
      <th style="width: 100px;">Zona</th>
      <th style="width: 100px;">Cucina</th>
      <th style="width: 100px;">Prezzo</th>
      <th style="width: 100px;">Tripadvisor</th>
      <th style="width: 100px;">Alessandro</th>
      <th style="width: 100px;">Francesca</th>
      <th style="width: 100px;">Giacomo</th>
      <th style="width: 100px;">Lucia</th>
      <th style="width: 70px;">Media</th>
      <th style="width: 95px;">Azioni</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<a href="index.html">
    <i class="fa-solid fa-arrow-left"></i> Torna all’inserimento / modifica
</a>

<!-- MODALE DETTAGLI E MODIFICA -->
<!-- MODALE DETTAGLI (solo lettura) -->
<div class="modal" id="popupDettagli">
  <div class="modal-content">
    <span class="modal-close" id="chiudiPopupDettagli">&times;</span>
    <h3 id="titoloPopup"></h3>
    <div class="popup-flex_det">
      <div class="popup-left" id="contenutoPopup"></div>
      <div class="popup-right" id="mappaPopup"></div>
    </div>
  </div>
</div>

<!-- MODALE MODIFICA -->
<div class="modal" id="popupModifica">
  <div class="modal-content">
    <span class="modal-close" id="chiudiPopupModifica">&times;</span>
    <h3 id="titoloModifica"></h3>
    <div id="contenutoModifica" class="popup-flex"></div>
  </div>
</div>


<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzuyvSKQkkOdyIXdxKIGxtCC7PEnOT9qwbi1CxCJYquPnQfwX-9Brs7tHzH2ccgnSh_gw/exec";

function mostraNotifica(testo="Elemento salvato!") {
  const esistente = document.querySelector(".notifica-salvato");
  if(esistente) esistente.remove();
  const notif = document.createElement("div");
  notif.className = "notifica-salvato";
  notif.innerHTML = `<i class="fa-solid fa-circle-check"></i> ${testo}`;
  document.body.appendChild(notif);
  setTimeout(() => notif.classList.add("visibile"), 50);
  setTimeout(() => { notif.classList.remove("visibile"); setTimeout(()=>notif.remove(),400); }, 2500);
}

async function caricaTabella() {
    const res = await fetch(scriptURL);
    const data = await res.json();

    const arr = data.map(r => {
        const voti = [r["Alessandro"], r["Francesca"], r["Giacomo"], r["Lucia"]].map(v=>parseFloat(v)||0).filter(v=>v>0);
        const media = voti.length ? voti.reduce((s,v)=>s+v,0)/voti.length : 0;
        let citta = "";
        if(r["Indirizzo"] && r["Indirizzo"].includes(",")) citta = r["Indirizzo"].split(",").pop().trim();
        return {...r, media, citta};
    }).sort((a,b)=>b.media - a.media);

    const tbody = document.querySelector("#tabellaRistoranti tbody");
    tbody.innerHTML = "";

    arr.forEach(r=>{
        const tr = document.createElement("tr");
        tr.dataset.citta = r.citta || "";
        tr.innerHTML = `
        <td>${r["Nome"]||""}</td><td>${r["Zona"]||""}</td><td>${r["Cucina"]||""}</td>
        <td>${r["Prezzo"]||""}</td><td>${r["Tripadvisor"]||""}</td>
        <td>${r["Alessandro"]||""}</td><td>${r["Francesca"]||""}</td>
        <td>${r["Giacomo"]||""}</td><td>${r["Lucia"]||""}</td>
        <td><b>${r.media? r.media.toFixed(1):""}</b></td>
        <td>
            <button class="btnDettagli" data-info='${JSON.stringify(r).replace(/'/g,"&apos;")}'><i class="fa-solid fa-eye"></i></button>
            <button class="btnModifica" data-info='${JSON.stringify(r).replace(/'/g,"&apos;")}'><i class="fa-solid fa-pen-to-square"></i></button>
            <button class="btnElimina" data-nome="${r["Nome"]}"><i class="fa-solid fa-trash"></i></button>
        </td>
        `;
        tbody.appendChild(tr);
    });
    
    // --- Dropdown città con icone personalizzate ---
    const wrapper = document.getElementById("selectCittaWrapper");
    const display = wrapper.querySelector(".select-display");
    const list = document.getElementById("cityOptions");
    const selectedSpan = document.getElementById("selectedCity");

    const cittaUniche = [...new Set(arr.map(r=>r.citta).filter(Boolean))].sort();

    // dizionario icone personalizzate
    const iconeCitta = {
        "Roma": "fa-city",
        "Milano": "fa-city",
        "Napoli": "fa-city",
        "Firenze": "fa-city",
        "Torino": "fa-city",
        "Aprica": "fa-mountain",
        "Bologna": "fa-city",
        "Venezia": "fa-city",
        "Diano Marina": "fa-sailboat",
        "Verona": "fa-city"
    };

    list.innerHTML = `
        <li data-value="">
        <i class="fa-solid fa-earth-europe" style="margin-right:6px;color:#6c7c74"></i> Tutte le città
        </li>
    ` + cittaUniche.map(c => {
        const icona = iconeCitta[c] || "fa-location-dot";
        return `<li data-value="${c}">
        <i class="fa-solid ${icona}" style="margin-right:6px;color:#6c7c74"></i> ${c}
        </li>`;
    }).join("");

    function normalizzaTesto(t) {
        return t
            .toLowerCase()
            .normalize("NFD")     // separa lettere e accenti
            .replace(/[\u0300-\u036f]/g, ""); // rimuove gli accenti
    }

    function applicaFiltri(cittaSelezionata = "") {
        const testo = normalizzaTesto(document.getElementById("filtro").value);
        const cittaFiltro = normalizzaTesto(cittaSelezionata || "").trim();

        document.querySelectorAll("#tabellaRistoranti tbody tr").forEach(tr => {
            const trCitta = normalizzaTesto(tr.dataset.citta || "").trim();
            const testoRiga = normalizzaTesto(tr.textContent);
            const matchTesto = testoRiga.includes(testo);
            const matchCitta = !cittaFiltro || trCitta === cittaFiltro;
            tr.style.display = (matchTesto && matchCitta) ? "" : "none";
        });
    }

    display.onclick = ()=>wrapper.classList.toggle("open");

    list.querySelectorAll("li").forEach(li=>{
        li.onclick = ()=>{
        selectedSpan.textContent = li.textContent;
        list.querySelectorAll("li").forEach(l=>l.classList.remove("selected"));
        li.classList.add("selected");
        wrapper.classList.remove("open");
        applicaFiltri(li.dataset.value);
        };
    });

    window.addEventListener("click", e=>{
        if(!wrapper.contains(e.target)) wrapper.classList.remove("open");
    });

    // Filtro testo input
    document.getElementById("filtro").addEventListener("input", ()=>{
        const selectedCity = document.querySelector("#cityOptions li.selected")?.dataset.value || "";
        applicaFiltri(selectedCity);
    });

    // --- Gestione ordinamento ---
    const sortWrapper = document.getElementById("selectOrdinaWrapper");
    const sortDisplay = sortWrapper.querySelector(".select-display");
    const sortList = document.getElementById("sortOptions");
    const selectedSort = document.getElementById("selectedSort");
    let tipoOrdinamento = ""; // memorizza il tipo attuale

    function ordinaTabella(tipo) {
        const tbody = document.querySelector("#tabellaRistoranti tbody");
        const righe = Array.from(tbody.querySelectorAll("tr"));

        righe.sort((a, b) => {
        const getVal = (tr, col) => tr.children[col].textContent.trim();
        if (tipo === "nome") {
            return getVal(a, 0).localeCompare(getVal(b, 0));
        } else if (tipo === "media") {
            return parseFloat(getVal(b, 9)) - parseFloat(getVal(a, 9));
        } else if (tipo === "tripadvisor") {
            return parseFloat(getVal(b, 4)) - parseFloat(getVal(a, 4));
        }
        return 0;
        });

        tbody.innerHTML = "";
        righe.forEach(tr => tbody.appendChild(tr));
        tipoOrdinamento = tipo;
    }

    sortDisplay.onclick = () => sortWrapper.classList.toggle("open");

    sortList.querySelectorAll("li").forEach(li => {
        li.onclick = () => {
        selectedSort.textContent = li.textContent;
        sortList.querySelectorAll("li").forEach(l => l.classList.remove("selected"));
        li.classList.add("selected");
        sortWrapper.classList.remove("open");
        ordinaTabella(li.dataset.value);
        };
    });

    window.addEventListener("click", e => {
        if (!sortWrapper.contains(e.target)) sortWrapper.classList.remove("open");
    });


    // Reset filtri
    document.getElementById("resetFiltri").addEventListener("click", () => {
        document.getElementById("filtro").value = "";
        selectedSpan.textContent = "Tutte le città";
        list.querySelectorAll("li").forEach(li => li.classList.remove("selected"));
        applicaFiltri("");

        // 🔄 Reset ordinamento
        tipoOrdinamento = "";
        selectedSort.textContent = "Ordina per...";
        document.querySelectorAll("#sortOptions li").forEach(li => li.classList.remove("selected"));
    });

    // --- Eventi popup dettagli ---
    document.querySelectorAll(".btnDettagli").forEach(btn=>{
        btn.addEventListener("click", e=>{
        const r = JSON.parse(e.currentTarget.dataset.info.replace(/&apos;/g,"'"));
        document.getElementById("titoloPopup").textContent = r["Nome"];
        document.getElementById("contenutoPopup").innerHTML = `
            <div class="info-row"><strong>Zona:</strong> ${r["Zona"]||"-"}</div>
            <div class="info-row"><strong>Indirizzo:</strong> ${r["Indirizzo"]||"-"}</div>
            <div class="info-row"><strong>Città:</strong> ${r.citta||"-"}</div>
            <div class="info-row"><strong>Cucina:</strong> ${r["Cucina"]||"-"}</div>
            <div class="info-row"><strong>Prezzo:</strong> ${r["Prezzo"]||"-"}</div>
            <div class="info-row"><strong>Tripadvisor:</strong> ${r["Tripadvisor"]||"-"}</div>
            <div class="info-row"><strong>Alessandro:</strong> ${r["Alessandro"]||"-"}</div>
            <div class="info-row"><strong>Francesca:</strong> ${r["Francesca"]||"-"}</div>
            <div class="info-row"><strong>Giacomo:</strong> ${r["Giacomo"]||"-"}</div>
            <div class="info-row"><strong>Lucia:</strong> ${r["Lucia"]||"-"}</div>
            <div class="info-row"><strong>Media:</strong> ${r.media? r.media.toFixed(1) : "-"}</div>
            <hr>
            <div class="info-row"><strong>Note:</strong><br> ${(r["Note"]||"<em>Nessuna nota</em>").replace(/\n/g,"<br>")}</div>
        `;
        if(r["Indirizzo"]){
            const query = encodeURIComponent(r["Indirizzo"]);
            document.getElementById("mappaPopup").innerHTML = `
            <div class="map-container">
                <iframe src="https://www.google.com/maps?q=${query}&output=embed" loading="lazy"></iframe>
            </div>
            <a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank" class="map-link">
                <i class="fa-solid fa-location-dot"></i> Apri su Google Maps
            </a>
            `;
        } else document.getElementById("mappaPopup").innerHTML="<em>Indirizzo non disponibile</em>";
        document.getElementById("popupDettagli").style.display="flex";
        });
    });

    document.getElementById("chiudiPopupDettagli").onclick = ()=>{ document.getElementById("popupDettagli").style.display="none"; };
    window.addEventListener("click", e=>{ if(e.target.id==="popupDettagli") document.getElementById("popupDettagli").style.display="none"; });

    // --- Eventi popup modifica ---
    document.querySelectorAll(".btnModifica").forEach(btn=>{
        btn.addEventListener("click", e=>{
        const r = JSON.parse(e.currentTarget.dataset.info.replace(/&apos;/g,"'"));
        apriPopupModifica(r);
        });
    });

    async function apriPopupModifica(r) {
        document.getElementById("titoloModifica").innerHTML = '<i class="fa-solid fa-wrench"></i> Modifica ' + r["Nome"];

        const campiGenerali = ["Zona","Indirizzo","Cucina","Prezzo","Tripadvisor"];
        const campiVoti = ["Alessandro","Francesca","Giacomo","Lucia","Note"];

    // costruisco due colonne
    const colSinistra = campiGenerali.map(c=>{
        const val = (r[c]||"").toString().replace(/"/g,"&quot;");
        return `<div class="info-row"><strong>${c}:</strong><br>
                <input type="${c==='Tripadvisor'?'number':'text'}" id="edit_${c}" value="${val}" ${c==='Tripadvisor'? 'step="0.1" min="0" max="10"':''}>
                </div>`;
    }).join("");

    const colDestra = campiVoti.map(c=>{
        if(c==="Note"){
        return `<div class="info-row"><strong>${c}:</strong><br>
                    <textarea id="edit_${c}" rows="6">${(r[c]||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea>
                </div>`;
        } else {
        const val = (r[c]||"").toString().replace(/"/g,"&quot;");
        return `<div class="info-row"><strong>${c}:</strong><br>
                    <input type="number" id="edit_${c}" value="${val}" step="0.1" min="0" max="10">
                </div>`;
        }
    }).join("");

    document.getElementById("contenutoModifica").innerHTML = `
        <div class="popup-left">${colSinistra}</div>
        <div class="popup-right">${colDestra}</div>
        <div style="text-align:center;margin-top:20px;width:100%;">
        <button id="salvaModifiche" class="salvaModifiche">
            <i class="fa-solid fa-floppy-disk"></i> Salva modifiche
        </button>
        </div>
    `;


    document.getElementById("popupModifica").style.display="flex";

    document.getElementById("salvaModifiche").onclick = async ()=>{
        const payload = { nome: r["Nome"] };
        [...campiGenerali, ...campiVoti].forEach(c=>{
        const el = document.getElementById("edit_"+c);
        if(el) payload[c] = el.value;
        });
        try {
            const res = await fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(`Errore HTTP ${res.status}`);
            
            const result = await res.json().catch(() => ({})); // in caso non torni JSON
            console.log("Risposta Google Script:", result);

            mostraNotifica("✅ Modifica salvata!");
            document.getElementById("popupModifica").style.display = "none";
            caricaTabella();

            } catch (err) {
            console.error("Errore nel salvataggio:", err);
            mostraNotifica("❌ Errore nel salvataggio, riprova.");
        }
    };
  }
  
    document.getElementById("chiudiPopupModifica").onclick = ()=>{ document.getElementById("popupModifica").style.display="none"; };
    window.addEventListener("click", e=>{ if(e.target.id==="popupModifica") document.getElementById("popupModifica").style.display="none"; });
    }

caricaTabella();
</script>
</body>
</html>
